<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Análise Profissional de Site — PrestAgora</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f4f6f9;
    color:#222;
  }

  /* SIDEBAR PADRÃO */
  .sidebar{
    width:250px;
    height:100vh;
    background:#0d6efd;
    color:#fff;
    position:fixed;
    left:0;
    top:0;
    padding:40px 0;
  }
  .sidebar h2{
    text-align:center;
    margin-bottom:40px;
    font-size:22px;
  }
  .sidebar a{
    display:block;
    padding:16px 22px;
    color:#fff;
    text-decoration:none;
    font-size:16px;
  }
  .sidebar a:hover{
    background:#0b5ed7;
  }
  .sidebar a.active{
    background:#0b5ed7;
  }

  /* MAIN PADRÃO */
  .main{
    margin-left:250px;
    padding:35px;
  }

  /* CARDS PADRÃO */
  .card{
    background:#fff;
    padding:25px;
    border-radius:12px;
    box-shadow:0 0 12px rgba(0,0,0,0.06);
    margin-bottom:25px;
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:16px;
  }

  h1{
    margin:0;
    font-size:24px;
    color:#333;
  }

  label{
    font-weight:600;
    display:block;
    margin-bottom:6px;
  }

  input[type=text]{
    width:65%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:15px;
  }

  button.btn{
    background:#0d6efd;
    color:#fff;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    cursor:pointer;
    font-size:15px;
  }

  .muted{
    color:#666;
    font-size:14px;
    margin-top:6px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:25px;
    align-items:start;
  }

  .section-title{
    font-size:18px;
    margin-bottom:12px;
    font-weight:700;
  }

  .result-block{
    margin-top:18px;
  }

  .audit-list{
    list-style:none;
    padding:0;
    margin:0;
  }
  .audit-list li{
    padding:10px 0;
    border-bottom:1px solid #f1f1f1;
  }

  .chip{
    display:inline-block;
    background:#eef5ff;
    color:#0d6efd;
    padding:7px 10px;
    border-radius:999px;
    margin:5px;
    font-size:14px;
  }

  .history-item{
    padding:10px;
    border-bottom:1px solid #eee;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .small{
    font-size:14px;
    color:#555;
  }

  canvas{
    background:transparent;
  }
</style>
</head>
<body>

<div class="sidebar">
  <h2>PrestAgora Digital</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="meusclientes.html">Meus Clientes</a>
  <a href="bibliotecaanuncios.html">Biblioteca de anúncios</a>
  <a class="active" href="analisesite.html">Análise de Site</a>
  <a href="#">Análise de Redes Sociais</a>
  <a href="#" onclick="sair()">Sair</a>
</div>

<div class="main">

  <div class="card topbar">
    <div>
      <h1>Análise Profissional de Site</h1>
      <div class="muted">Insira a URL do site para obter performance, SEO e palavras-chave.</div>
    </div>
    <div>
      <button class="btn" onclick="exportHistory()">Exportar Histórico</button>
      <button class="btn" style="background:#28a745;margin-left:10px;" onclick="clearHistory()">Limpar Histórico</button>
    </div>
  </div>

  <div class="card">
    <label for="siteInput">URL do Site</label>
    <input type="text" id="siteInput" placeholder="https://exemplo.com" />
    <button class="btn" style="margin-left:10px;" onclick="submitAnalyze()">Analisar</button>
    <div id="info" class="muted">Use a URL completa (inclua https://).</div>
  </div>

  <div class="grid">

    <!-- RESULTADOS -->
    <div class="card">
      <div class="section-title">Resultados</div>

      <div id="loading" style="display:none;">⏳ Carregando...</div>

      <div id="resultArea" style="display:none;">

        <div style="display:flex; gap:25px; align-items:center; margin-bottom:20px;">
          <div>
            <div class="small">Performance</div>
            <h2 id="perfScore">-</h2>
            <div class="muted small" id="perfDetail"></div>
          </div>

          <div>
            <div class="small">SEO</div>
            <h2 id="seoScore">-</h2>
            <div class="muted small" id="seoDetail"></div>
          </div>

          <div>
            <div class="small">Acessibilidade</div>
            <h2 id="accScore">-</h2>
            <div class="muted small" id="accDetail"></div>
          </div>
        </div>

        <hr style="margin:20px 0;">

        <div>
          <div class="section-title">Sugestões</div>
          <ul id="audits" class="audit-list"></ul>
        </div>

        <hr style="margin:20px 0;">

        <div>
          <div class="section-title">Palavras-chave estimadas</div>
          <div id="keywords" style="display:flex; flex-wrap:wrap;"></div>
        </div>

        <div style="margin-top:20px;">
          <button class="btn" onclick="downloadReport()">Baixar Relatório (JSON)</button>
        </div>

      </div>
    </div>

    <!-- LATERAL -->
    <div>

      <div class="card">
        <div class="section-title">Gráfico: Performance x SEO</div>
        <canvas id="chartPerf" width="380" height="240"></canvas>
      </div>

      <div class="card" style="margin-top:25px;">
        <div class="section-title">Histórico</div>
        <div id="historyList" style="max-height:350px; overflow:auto;"></div>
      </div>

    </div>

  </div>

</div>

<script>
/* ---------- Config ------------------ */
const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '/api';

/* ---------- Helpers ------------------ */
function q(s){ return document.querySelector(s); }
function hide(e){ e.style.display='none'; }
function show(e){ e.style.display='block'; }

/* ---------- State ------------------ */
let lastReport = null;

/* ---------- Submit ------------------ */
async function submitAnalyze(){
  const input = q('#siteInput').value.trim();
  if(!input){ return alert('Insira a URL.'); }

  show(q('#loading'));
  hide(q('#resultArea'));

  try {
    const r = await fetch(API_BASE + '/api/analyze', {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ url: input })
    });

    if(!r.ok){
      throw new Error(await r.text());
    }

    const data = await r.json();
    lastReport = data;

    renderResult(data);
    saveToHistory(input, data);

  } catch(e){
    alert("Erro: " + e.message);
  }

  hide(q('#loading'));
}

/* ---------- Render ------------------ */
function renderResult(d){
  show(q('#resultArea'));

  q('#perfScore').innerText = (d.performance || 0) + " / 100";
  q('#seoScore').innerText = (d.seoScore || 0) + " / 100";
  q('#accScore').innerText = (d.accessibility || 0) + " / 100";

  q('#perfDetail').innerText = d.lighthouseSummary || "";
  q('#seoDetail').innerText = d.seoSummary || "";
  q('#accDetail').innerText = d.accessibilityDetail || "";

  const audits = q('#audits');
  audits.innerHTML = "";
  (d.audits || []).forEach(a=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>${a.title}</strong><br><span class="small">${a.description}</span>`;
    audits.appendChild(li);
  });

  const kw = q('#keywords');
  kw.innerHTML = "";
  (d.topKeywords || []).slice(0,20).forEach(k=>{
    const c = document.createElement('span');
    c.className = "chip";
    c.innerText = k;
    kw.appendChild(c);
  });

  updateChart(d);
}

/* ---------- Chart ------------------ */
let chart;
function updateChart(d){
  const ctx = q("#chartPerf").getContext("2d");
  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Performance","SEO"],
      datasets:[{
        label:"Score",
        data:[d.performance || 0, d.seoScore || 0],
        backgroundColor:["#0d6efd","#28a745"]
      }]
    },
    options:{
      responsive:true,
      scales:{ y:{ beginAtZero:true, max:100 } }
    }
  });
}

/* ---------- History ------------------ */
function saveToHistory(url,data){
  const h = JSON.parse(localStorage.getItem("pa_hist") || "[]");

  h.unshift({
    url,
    when:new Date().toISOString(),
    perf:data.performance || 0,
    seo:data.seoScore || 0
  });

  localStorage.setItem("pa_hist", JSON.stringify(h.slice(0,40)));

  renderHistory();
}

function renderHistory(){
  const h = JSON.parse(localStorage.getItem("pa_hist") || "[]");
  const box = q("#historyList");
  box.innerHTML = "";

  if(h.length === 0){
    box.innerHTML = `<div class="muted">Nenhum histórico ainda.</div>`;
    return;
  }

  h.forEach(i=>{
    const d = document.createElement("div");
    d.className = "history-item";
    d.innerHTML = `
      <div>
        <strong>${i.url}</strong>
        <div class="small">${new Date(i.when).toLocaleString()}</div>
      </div>
      <div style="text-align:right">
        <div class="small">P: ${i.perf}</div>
        <div class="small">SEO: ${i.seo}</div>
      </div>
    `;
    box.appendChild(d);
  });
}
renderHistory();

/* ---------- Export ------------------ */
function exportHistory(){
  const h = localStorage.getItem("pa_hist") || "[]";
  const blob = new Blob([h], { type:"application/json" });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="historico_analises.json";
  a.click();
}

function clearHistory(){
  if(!confirm("Limpar histórico?")) return;
  localStorage.removeItem("pa_hist");
  renderHistory();
}

function downloadReport(){
  if(!lastReport) return alert("Nenhum relatório para baixar.");
  const b = new Blob([JSON.stringify(lastReport,null,2)], { type:"application/json" });
  const a=document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download="relatorio.json";
  a.click();
}

function sair(){
  window.location.href="login.html";
}
</script>

</body>
</html>
