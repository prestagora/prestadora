<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Análise Profissional de Site — PrestAgora</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* ---------------------------------------------------
     GERAL
  --------------------------------------------------- */
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f4f6f9;
    color:#222;
  }

  /* ---------------------------------------------------
     SIDEBAR (PADRÃO IGUAL A TODOS OS OUTROS)
  --------------------------------------------------- */
  .sidebar{
    width:250px;
    height:100vh;
    background:#0d6efd;
    color:#fff;
    position:fixed;
    left:0;
    top:0;
    padding:40px 0;
    box-shadow:3px 0 10px rgba(0,0,0,0.15);
  }
  .sidebar h2{
    text-align:center;
    margin-bottom:40px;
    font-size:22px;
    font-weight:bold;
  }
  .sidebar a{
    display:block;
    padding:16px 22px;
    color:#fff;
    text-decoration:none;
    font-size:16px;
    transition:0.2s;
  }
  .sidebar a:hover{
    background:#0b5ed7;
  }
  .sidebar a.active{
    background:#0b5ed7;
    font-weight:bold;
  }

  /* Contas Meta Ads submenu */
  .contas-lista{
    padding-left:22px;
    display:none;
    margin-bottom:10px;
  }
  .conta-item{
    padding:8px 0;
    color:#fff;
    font-size:14px;
  }

  /* ---------------------------------------------------
     MAIN AREA (PADRÃO IGUAL AOS OUTROS)
  --------------------------------------------------- */
  .main{
    margin-left:250px;
    padding:35px;
  }

  /* ---------------------------------------------------
     CARDS (PADRÃO PRESTAGORA)
  --------------------------------------------------- */
  .card{
    background:#fff;
    padding:25px;
    border-radius:12px;
    box-shadow:0 0 12px rgba(0,0,0,0.06);
    margin-bottom:25px;
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:20px;
  }

  h1{
    margin:0;
    font-size:24px;
    color:#333;
    font-weight:700;
  }

  label{
    font-weight:600;
    display:block;
    margin-bottom:6px;
  }

  input[type=text]{
    width:65%;
    padding:12px;
    border-radius:8px;
    border:1px solid #ddd;
    font-size:15px;
  }

  button.btn{
    background:#0d6efd;
    color:#fff;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    cursor:pointer;
    font-size:15px;
    transition:0.2s;
  }
  button.btn:hover{
    background:#0b5ed7;
  }

  .muted{
    color:#666;
    font-size:14px;
    margin-top:6px;
  }

  /* ---------------------------------------------------
     GRID PRINCIPAL
  --------------------------------------------------- */
  .grid{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:25px;
    align-items:start;
  }

  .section-title{
    font-size:18px;
    margin-bottom:12px;
    font-weight:700;
  }

  .audit-list{
    list-style:none;
    padding:0;
    margin:0;
  }
  .audit-list li{
    padding:10px 0;
    border-bottom:1px solid #f1f1f1;
  }

  .chip{
    display:inline-block;
    background:#eef5ff;
    color:#0d6efd;
    padding:7px 10px;
    border-radius:999px;
    margin:5px;
    font-size:14px;
    font-weight:600;
  }

  .history-item{
    padding:12px;
    border-bottom:1px solid #eee;
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    transition:0.2s;
  }
  .history-item:hover{
    background:#f0f4ff;
  }

  .small{
    font-size:14px;
    color:#555;
  }

  canvas{
    background:transparent;
  }
</style>
</head>
<body>

<!-- ---------------------------------------------------
     SIDEBAR
--------------------------------------------------- -->
<div class="sidebar">
  <h2>PrestAgora Digital</h2>

  <a href="dashboard.html">Dashboard</a>

  <a href="#contas" onclick="toggleContas()">Contas Meta Ads <span id="setaConta">▼</span></a>
  <div class="contas-lista" id="listaContas"></div>

  <a href="meusclientes.html">Meus Clientes</a>
  <a href="minhaagenda.html">Minha Agenda</a>
  <a href="bibliotecaanuncios.html">Biblioteca de anúncios</a>
  <a class="active" href="analisesite.html">Análise de Site</a>
  <a href="analiseredes.html">Análise de Redes Sociais</a>
  <a href="#" onclick="sair()">Sair</a>
</div>

<!-- ---------------------------------------------------
     MAIN CONTENT
--------------------------------------------------- -->
<div class="main">

  <div class="card topbar">
    <div>
      <h1>Análise Profissional de Site</h1>
      <div class="muted">Insira a URL do site para obter performance, SEO e palavras-chave.</div>
    </div>

    <div>
      <button class="btn" onclick="exportHistory()">Exportar Histórico</button>
      <button class="btn" style="background:#28a745;margin-left:10px;" onclick="clearHistory()">Limpar Histórico</button>
    </div>
  </div>

  <div class="card">
    <label for="siteInput">URL do Site</label>
    <input type="text" id="siteInput" placeholder="https://exemplo.com" />
    <button class="btn" style="margin-left:10px;" onclick="submitAnalyze()">Analisar</button>
    <div id="info" class="muted">Use a URL completa (inclua https://).</div>
  </div>

  <div class="grid">

    <!-- RESULTADOS -->
    <div class="card">
      <div class="section-title">Resultados</div>

      <div id="loading" style="display:none;">⏳ Carregando...</div>

      <div id="resultArea" style="display:none;">

        <div style="display:flex; gap:40px; align-items:center; margin-bottom:25px;">

          <div>
            <div class="small">Performance</div>
            <h2 id="perfScore">-</h2>
            <div class="muted small" id="perfDetail"></div>
          </div>

          <div>
            <div class="small">SEO</div>
            <h2 id="seoScore">-</h2>
            <div class="muted small" id="seoDetail"></div>
          </div>

          <div>
            <div class="small">Acessibilidade</div>
            <h2 id="accScore">-</h2>
            <div class="muted small" id="accDetail"></div>
          </div>

        </div>

        <hr style="margin:20px 0;">

        <div>
          <div class="section-title">Sugestões</div>
          <ul id="audits" class="audit-list"></ul>
        </div>

        <hr style="margin:20px 0;">

        <div>
          <div class="section-title">Palavras-chave estimadas</div>
          <div id="keywords" style="display:flex; flex-wrap:wrap;"></div>
        </div>

        <div style="margin-top:20px;">
          <button class="btn" onclick="downloadReport()">Baixar Relatório (JSON)</button>
        </div>

      </div>
    </div>

    <!-- LATERAL -->
    <div>

      <div class="card">
        <div class="section-title">Gráfico: Performance x SEO</div>
        <canvas id="chartPerf" width="380" height="240"></canvas>
      </div>

      <div class="card" style="margin-top:25px;">
        <div class="section-title">Histórico</div>
        <div id="historyList" style="max-height:350px; overflow:auto;"></div>
      </div>

    </div>

  </div>

</div>

<script>
/* ---------------------------------------------------
   CONFIG
--------------------------------------------------- */
const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '/api';

/* Helpers */
function q(s){ return document.querySelector(s); }
function hide(e){ if(e) e.style.display='none'; }
function show(e){ if(e) e.style.display='block'; }

/* ---------------------------------------------------
   CONTAS META ADS
--------------------------------------------------- */
function toggleContas(){
  const lista = document.getElementById('listaContas');
  const seta = document.getElementById('setaConta');
  const aberto = lista.style.display === 'block';
  lista.style.display = aberto ? 'none' : 'block';
  seta.style.transform = aberto ? 'rotate(0deg)' : 'rotate(180deg)';
}

function mostrarContas(){
  const lista = document.getElementById('listaContas');
  lista.innerHTML = '';
  const contas = JSON.parse(localStorage.getItem('contas_meta') || '[]');
  if(!contas || contas.length === 0){
    lista.innerHTML = '<div class="conta-item">Nenhuma conta conectada</div>';
    return;
  }
  contas.forEach(c => {
    const div = document.createElement('div');
    div.className = 'conta-item';
    div.innerText = `• ${c.name || c.account_id || 'Conta'} (${c.account_id || '-'})`;
    lista.appendChild(div);
  });
}

/* ---------------------------------------------------
   ANALISAR SITE
--------------------------------------------------- */
let lastReport = null;

async function submitAnalyze(){
  const input = q('#siteInput').value.trim();
  if(!input){ alert('Insira a URL do site.'); return; }

  show(q('#loading'));
  hide(q('#resultArea'));

  try {
    const res = await fetch(API_BASE + '/api/analyze', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ url: input })
    });

    if(!res.ok){
      const txt = await res.text();
      throw new Error('Erro na API: ' + txt);
    }
    const data = await res.json();
    lastReport = data;
    renderResult(data);
    saveToHistory(input, data);
  } catch (err) {
    console.error(err);
    alert('Erro ao analisar: ' + err.message);
  } finally {
    hide(q('#loading'));
  }
}

/* ---------------------------------------------------
   RENDERIZAÇÃO
--------------------------------------------------- */
function renderResult(data){
  show(q('#resultArea'));

  q('#perfScore').innerText = (data.performance || 0).toFixed(0) + ' / 100';
  q('#seoScore').innerText = (data.seoScore || 0).toFixed(0) + ' / 100';
  q('#accScore').innerText = (data.accessibility || 0).toFixed(0) + ' / 100';

  q('#perfDetail').innerText = data.lighthouseSummary || '';
  q('#seoDetail').innerText = data.seoSummary || '';
  q('#accDetail').innerText = data.accessibilityDetail || '';

  const audits = q('#audits');
  audits.innerHTML = '';
  (data.audits || []).forEach(a=>{
    const li = document.createElement('li');
    li.innerHTML = '<strong>' + a.title + '</strong><br><span class="small">' + a.description + '</span>';
    audits.appendChild(li);
  });

  const kw = q('#keywords');
  kw.innerHTML = '';
  (data.topKeywords || []).slice(0,20).forEach(k=>{
    const d = document.createElement('span');
    d.className = 'chip';
    d.innerText = k;
    kw.appendChild(d);
  });

  updateChart(data);
}

/* ---------------------------------------------------
   GRÁFICO
--------------------------------------------------- */
let chart;
function updateChart(data){
  const perf = data.performance || 0;
  const seo = data.seoScore || 0;
  const ctx = q('#chartPerf').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'bar',
    data:{
      labels:['Performance','SEO'],
      datasets:[
        {
          label:'Score',
          data:[perf,seo],
          backgroundColor:['#0d6efd','#28a745']
        }
      ]
    },
    options:{
      responsive:true,
      scales:{ y:{ beginAtZero:true, max:100 } }
    }
  });
}

/* ---------------------------------------------------
   HISTÓRICO
--------------------------------------------------- */
function saveToHistory(url, data){
  const hist = JSON.parse(localStorage.getItem('pa_history') || '[]');
  hist.unshift({ url, when: new Date().toISOString(), perf: data.performance || 0, seo: data.seoScore || 0, report: data });
  localStorage.setItem('pa_history', JSON.stringify(hist.slice(0,50)));
  renderHistory();
}

function renderHistory(){
  const hist = JSON.parse(localStorage.getItem('pa_history') || '[]');
  const container = q('#historyList');
  container.innerHTML = '';
  if(hist.length===0){
    container.innerHTML = '<div class="muted">Sem histórico.</div>';
    return;
  }
  hist.forEach(h=>{
    const d = document.createElement('div');
    d.className = 'history-item';
    d.innerHTML = `
      <div>
        <strong>${h.url}</strong>
        <div class="small">${new Date(h.when).toLocaleString()}</div>
      </div>
      <div style="text-align:right">
        <div class="small">P ${Math.round(h.perf)}</div>
        <div class="small">SEO ${Math.round(h.seo)}</div>
      </div>`;
    d.addEventListener('click', ()=>{
      if(confirm('Carregar relatório deste item?')){
        renderResult(h.report || {});
      }
    });
    container.appendChild(d);
  });
}
renderHistory();

/* ---------------------------------------------------
   EXPORTAR / BAIXAR
--------------------------------------------------- */
function downloadReport(){
  if(!lastReport){
    alert('Nenhum relatório para baixar.');
    return;
  }
  const blob = new Blob([JSON.stringify(lastReport, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'relatorio_site.json';
  a.click();
}

function exportHistory(){
  const h = localStorage.getItem('pa_history') || '[]';
  const b = new Blob([h], {type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download='historico_analises.json';
  a.click();
}

function clearHistory(){
  if(!confirm('Limpar histórico?')) return;
  localStorage.removeItem('pa_history');
  renderHistory();
}

function sair(){
  alert('Sair — você será redirecionado.');
  window.location.href='login.html';
}

/* ---------------------------------------------------
   ONLOAD
--------------------------------------------------- */
window.onload = function(){
  mostrarContas();
  renderHistory();
};
</script>

</body>
</html>
