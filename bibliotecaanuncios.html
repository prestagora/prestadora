<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biblioteca de Anúncios - PrestAgora</title>
<style>
  body{ margin:0; font-family:Arial, sans-serif; background:#f4f6f9; }
  .sidebar{ width:250px; height:100vh; background:#0d6efd; color:#fff; position:fixed; left:0; top:0; padding-top:30px; }
  .sidebar a{ display:block; padding:12px 20px; color:#fff; text-decoration:none; }
  .main{ margin-left:250px; padding:20px; }
  .topbar{ background:#fff; padding:12px 16px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.06); display:flex; justify-content:space-between; align-items:center;}
  .btn{ background:#0d6efd; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  .card{ margin-top:14px; background:#fff; padding:14px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
  .ad-card{ background:#f8f9fa; padding:10px; margin-bottom:10px; border-left:4px solid #0d6efd; border-radius:6px; }
  input[type=file]{ display:none; }
  .muted{ color:#666; font-size:13px; margin-top:6px; }
</style>
</head>
<body>
  <div class="sidebar">
    <h2 style="text-align:center;margin:0 0 12px 0">PrestAgora Digital</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="meusclientes.html">Meus Clientes</a>
    <a href="bibliotecaanuncios.html" style="background:#0b5ed7">Biblioteca de Anúncios</a>
    <a href="#">Análise de Sites</a>
    <a href="#">Análise de Redes Sociais</a>
  </div>

  <div class="main">
    <div class="topbar">
      <h2 style="margin:0">Mineração de Anúncios</h2>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="ativarExtensao()">Ativar Extensão</button>
        <button class="btn" onclick="abrirBiblioteca()">Ativar Minerador</button>
      </div>
    </div>

    <div class="card">
      <h3>Anúncios Salvos</h3>
      <p class="muted">Importe o arquivo JSON exportado pela extensão ou cole o JSON no campo.</p>

      <div style="display:flex;gap:8px; margin-top:8px;">
        <label class="btn" for="fileInput" style="cursor:pointer;">Importar JSON</label>
        <button class="btn" onclick="pasteImport()">Colar JSON</button>
        <button class="btn" onclick="clearDisplayed()">Limpar</button>
      </div>

      <input type="file" id="fileInput" accept="application/json" />

      <div id="savedContainer" style="margin-top:12px;"></div>
    </div>
  </div>

<script>
const LIB_URL = 'https://www.facebook.com/ads/library/?active_status=all&ad_type=all&country=BR';

function abrirBiblioteca(){
  window.open(LIB_URL, '_blank');
}
function ativarExtensao(){
  alert('Abrindo página de extensões. Ative a extensão PrestAgora Minerador manualmente.');
  window.open('chrome://extensions', '_blank');
}

// file import
document.getElementById('fileInput').addEventListener('change', async (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const txt = await f.text();
  try {
    const arr = JSON.parse(txt);
    displayAds(arr);
  } catch (e) {
    alert('Arquivo inválido');
  }
});

function pasteImport(){
  const txt = prompt('Cole aqui o JSON exportado pela extensão (CTRL+V) e pressione OK:');
  if (!txt) return;
  try {
    const arr = JSON.parse(txt);
    displayAds(arr);
  } catch(e) {
    alert('JSON inválido');
  }
}

function displayAds(arr){
  const container = document.getElementById('savedContainer');
  container.innerHTML = '';
  if (!Array.isArray(arr) || arr.length === 0){
    container.innerHTML = '<div class="muted">Nenhum anúncio encontrado no JSON.</div>';
    return;
  }
  arr.forEach(ad => {
    const d = document.createElement('div');
    d.className = 'ad-card';
    d.innerHTML = `<strong>${ad.page || 'Anúncio'}</strong>
                   <div style="margin-top:6px">${(ad.text || '').slice(0,800)}</div>
                   <div style="margin-top:8px">
                     <button class="btn" onclick='downloadJSON(${JSON.stringify(JSON.stringify(ad)).replace(/</g,"\\u003c")})'>Baixar JSON</button>
                   </div>`;
    container.appendChild(d);
  });
}

function clearDisplayed(){ document.getElementById('savedContainer').innerHTML = ''; }

function downloadJSON(strified){
  // strified is a JSON string double-encoded, decode first
  try {
    const s = JSON.parse(strified);
    const blob = new Blob([s], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'anuncio.json';
    a.click();
    URL.revokeObjectURL(url);
  } catch(e){
    alert('Erro ao baixar');
  }
}
</script>
</body>
</html>
