<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Plataforma de Marketing</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; background:#f4f6f9; font-family:Arial,sans-serif; }
.sidebar { width:250px; height:100vh; background:#0d6efd; color:#fff; position:fixed; left:0; top:0; padding-top:30px; }
.sidebar h2 { text-align:center; margin-bottom:30px; font-size:20px; }
.sidebar a { display:block; padding:15px 20px; color:#fff; text-decoration:none; font-size:16px; }
.sidebar a:hover { background:#0b5ed7; cursor:pointer; }
.main { margin-left:250px; padding:30px; }
.card { background:#fff; padding:25px; border-radius:10px; box-shadow:0 0 12px rgba(0,0,0,0.1); margin-bottom:25px; }
.topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; gap:15px; }
.topbar h1 { margin:0; font-size:24px; color:#333; flex:1; }
.topbar .acoes { display:flex; gap:10px; align-items:center; }
.btn { background:#0d6efd; border:none; padding:10px 20px; color:#fff; border-radius:6px; cursor:pointer; font-size:15px; }
.btn:hover { background:#0b5ed7; }
.flex-container { display:flex; gap:30px; flex-wrap:wrap; }
.despesas-card, .grafico-card { flex:1; min-width:300px; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
th { background-color:#f0f0f0; }
input[type="text"], input[type="number"], select { width:100%; padding:8px; margin:3px 0; border-radius:5px; border:1px solid #ccc; }
.timer { display:flex; gap:10px; align-items:center; }
.timer span { font-size:16px; font-weight:bold; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>PrestAgora digital</h2>
    <a href="#">Dashboard</a>
    <a href="#contas" onclick="toggleContas()">Contas Meta Ads <span class="seta" id="seta">▼</span></a>
    <div class="contas-lista" id="listaContas"></div>
    <a href="meusclientes.html">Meus Clientes</a>
    <a href="#">Biblioteca de anúncios</a>
    <a href="#">Analise de sites</a>
    <a href="#">Analise de redes sociais</a>
    <a href="#" onclick="sair()">Sair</a>
</div>

<div class="main">

    <div class="topbar">
        <h1>Dashboard</h1>
        <div class="acoes">
            <button class="btn" id="btnMeta" onclick="loginFacebook()">Conectar Meta Ads</button>
            <div class="timer">
                <span id="tempo">00:00:00</span>
                <button class="btn" id="btnIniciar" onclick="iniciarTimer()">Iniciar</button>
                <button class="btn" id="btnParar" onclick="pararTimer()">Parar</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Bem-vindo à Plataforma de Marketing</h3>
        <p>Gerencie suas contas, campanhas e relatórios de forma automatizada.</p>
    </div>

    <div class="flex-container">
        <!-- Despesas -->
        <div class="despesas-card card">
            <h3>Minhas Despesas</h3>
            <label>Descrição</label>
            <input type="text" id="descDespesa" placeholder="Ex: Internet, Software...">
            <label>Categoria</label>
            <input type="text" id="catDespesa" placeholder="Ex: Tecnologia, Escritório...">
            <label>Valor (R$)</label>
            <input type="number" id="valDespesa" placeholder="0.00">
            <button class="btn" onclick="adicionarDespesa()">Adicionar Despesa</button>
            <table>
                <thead>
                    <tr><th>Descrição</th><th>Categoria</th><th>Valor (R$)</th><th>Ações</th></tr>
                </thead>
                <tbody id="tabelaDespesas"></tbody>
            </table>
        </div>

        <!-- Receita vs Despesas -->
        <div class="grafico-card card">
            <h3>Receita vs Despesas</h3>
            <canvas id="grafico"></canvas>
        </div>
    </div>

    <!-- Gráfico Produtividade -->
    <div class="card">
        <h3>Produtividade</h3>
        <canvas id="graficoProdutividade"></canvas>
    </div>

</div>

<div id="fb-root"></div>
<script src="https://connect.facebook.net/pt_BR/sdk.js"></script>
<script>
// ----------------------- DESPESAS -----------------------
let despesas = JSON.parse(localStorage.getItem("despesas") || "[]");
function adicionarDespesa() {
    const desc = document.getElementById("descDespesa").value.trim();
    const cat = document.getElementById("catDespesa").value.trim();
    const val = parseFloat(document.getElementById("valDespesa").value);
    if(!desc || !cat || isNaN(val)) { alert("Preencha todos os campos."); return; }
    despesas.push({desc, cat, val});
    localStorage.setItem("despesas", JSON.stringify(despesas));
    atualizarTabela(); atualizarGrafico();
    document.getElementById("descDespesa").value = "";
    document.getElementById("catDespesa").value = "";
    document.getElementById("valDespesa").value = "";
}
function atualizarTabela() {
    const tbody = document.getElementById("tabelaDespesas");
    tbody.innerHTML = "";
    despesas.forEach((d,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.desc}</td><td>${d.cat}</td><td>${d.val.toFixed(2)}</td>
                        <td><button onclick="removerDespesa(${i})">Excluir</button></td>`;
        tbody.appendChild(tr);
    });
}
function removerDespesa(index) {
    despesas.splice(index,1);
    localStorage.setItem("despesas", JSON.stringify(despesas));
    atualizarTabela(); atualizarGrafico();
}

// ----------------------- GRAFICO RECEITA VS DESPESAS -----------------------
function calcularReceita() {
    const clientes = JSON.parse(localStorage.getItem("clientes") || "[]");
    return clientes.reduce((acc,c)=>acc+parseFloat(c.valor||0),0);
}
const ctx = document.getElementById("grafico").getContext("2d");
let graficoChart;
function atualizarGrafico() {
    const receita = calcularReceita();
    const totalDespesas = despesas.reduce((acc,d)=>acc+d.val,0);
    const data = {
        labels:["Receita","Despesas"],
        datasets:[{ label:"R$", data:[receita,totalDespesas], backgroundColor:["#0d6efd","#dc3545"] }]
    };
    if(graficoChart) graficoChart.destroy();
    graficoChart = new Chart(ctx,{ type:'bar', data:data, options:{ responsive:true, plugins:{legend:{display:false}} } });
}

// ----------------------- TEMPORIZADOR -----------------------
let timerInterval;
let segundos = 0;
let produtividade = JSON.parse(localStorage.getItem("produtividade") || "[]");
function formatarTempo(sec) {
    let h = Math.floor(sec/3600).toString().padStart(2,'0');
    let m = Math.floor((sec%3600)/60).toString().padStart(2,'0');
    let s = (sec%60).toString().padStart(2,'0');
    return `${h}:${m}:${s}`;
}
function iniciarTimer() {
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        segundos++;
        document.getElementById("tempo").innerText = formatarTempo(segundos);
    },1000);
}
function pararTimer() {
    clearInterval(timerInterval);
    const agora = new Date();
    produtividade.push({data: agora.toLocaleDateString(), horas: segundos/3600});
    localStorage.setItem("produtividade", JSON.stringify(produtividade));
    segundos = 0;
    document.getElementById("tempo").innerText = "00:00:00";
    atualizarGraficoProdutividade();
}

// ----------------------- GRAFICO PRODUTIVIDADE -----------------------
const ctxProd = document.getElementById("graficoProdutividade").getContext("2d");
let graficoProd;
function atualizarGraficoProdutividade() {
    const labels = produtividade.map(p => p.data);
    const data = produtividade.map(p => parseFloat(p.horas.toFixed(2)));
    if(graficoProd) graficoProd.destroy();
    graficoProd = new Chart(ctxProd,{
        type:'line',
        data:{ labels, datasets:[{ label:"Horas Trabalhadas", data, borderColor:"#28a745", backgroundColor:"rgba(40,167,69,0.2)", fill:true }]},
        options:{ responsive:true, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:true}}}
    });
}

// ----------------------- META ADS -----------------------
function loginFacebook(){
    FB.getLoginStatus(function(response){
        if(response.status==='connected'){
            document.getElementById("btnMeta").innerText="Conectado ✓";
            carregarContasMeta();
        } else {
            FB.login(function(resp){
                if(resp.status==='connected'){
                    document.getElementById("btnMeta").innerText="Conectado ✓";
                    carregarContasMeta();
                } else {
                    alert("Você precisa permitir o acesso para continuar.");
                }
            }, {scope:'ads_read,ads_management,business_management'});
        }
    });
}
function carregarContasMeta() {
    FB.api('/me/adaccounts', function(response){
        if(response && !response.error){
            localStorage.setItem("contas_meta", JSON.stringify(response.data));
            mostrarContas();
        } else { alert("Erro ao carregar contas Meta Ads."); }
    });
}
function mostrarContas() {
    const lista = document.getElementById("listaContas");
    lista.innerHTML = "";
    const contas = JSON.parse(localStorage.getItem("contas_meta")||"[]");
    contas.forEach(c=>{
        lista.innerHTML += `<div class="conta-item">• ${c.name} (${c.account_id})</div>`;
    });
}
function toggleContas(){
    const lista=document.getElementById("listaContas");
    const seta=document.getElementById("seta");
    const aberto=lista.style.display==="block";
    lista.style.display=aberto?"none":"block";
    seta.style.transform=aberto?"rotate(0deg)":"rotate(180deg)";
}
function sair(){ localStorage.clear(); alert("Você saiu da plataforma."); location.reload(); }

// ----------------------- ONLOAD -----------------------
window.onload = function(){
    atualizarTabela(); atualizarGrafico(); atualizarGraficoProdutividade();
    if(localStorage.getItem("contas_meta")){
        document.getElementById("btnMeta").innerText="Conectado ✓";
        mostrarContas();
    }
};
</script>
</body>
</html>
